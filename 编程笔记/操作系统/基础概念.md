## 什么是操作系统
操作系统（Operation System, OS）是管理计算机硬件与软件资源的系统软件，同时也是计算机系统的内核与基石。操作系统需要处理管理与配置内存、
决定系统资源供需的优先次序、控制输入与输出设备、操作网络与管理文件系统等基本事务。操作系统也提供一个让用户与系统交互的操作界面。

> 通常操作系统是介于软件和硬件之间的，它提供了一系列接口以便软件可以通过这些接口去操作计算机的各种硬件资源。

## 操作系统的特征
操作系统有四个特征，分别是并发性、共享性、虚拟性、异步性，其中并发和共享是最基本的两个特征。

### 并发性
指定是两个或者多个事件在同一时刻内间隔发生。但是对单核CPU而言在宏观上是同时发生的，但是在微观上是交替发生的。而多核CPU无论是从微观上，
还是宏观上都是同时发送的。

但是大多数情况下操作系统的并发性指的是计算机系统中 “同时” 运行着多个程序，这些程序宏观上看着是同时运行的，但微观上是交替运行的。

### 共享性
系统中的资源可供内存中多个并发执行的进程共同使用。而资源共享方式有两种：互斥共享方式和同时共享方式。顾名思义：
**互斥共享方式**：系统中的某些资源，虽然可以提供给多个进程使用，但一个时间段内只允许一个进程访问该资源。
**同时共享方式**：系统中的某些资源，一个时间段内允许多个进程对它们进行访问。
比如一些临界资源，程序在使用它们的时候都是独占的，不可以同时使用，这时就需要互斥共享的方式。

### 虚拟性
虚拟性指的是一个物理上的实体虚拟为若干个逻辑上的逻辑对象，对于这种用户是有感的。虚拟技术包含两个方面：
**时分复用技术**：利用处理机的空闲时间运行其他程序。
**空分复用技术**：利用存储器的空闲空间分区存放和运行其他的多道程序。
时分复用技术可以充分利用计算机的CPU资源，从而保证并发性，虚拟存储器技术可以充分的利用计算机的存储资源。

### 异步性
在多道程序环境下，运行多个程序并发执行，但由于资源有限，进程的执行不是一贯到底的，而是走走停停，以不可以预知的速度向前推进，这既是进程的异步性。

## 操作系统是如何被启动的
1. 加电自检：当计算机启动后，会先进行硬件自检；
2. 引导加载程序：自检通过后加载引导程序，从预设的启动设备的第一扇区读取主引导记录（MBR），该记录包含了引导程序和磁盘相关的分区信息。
3. 操作系统内核加载：引导加载程序负责加载操作系统的内核到内存。
4. 内核初始化：一旦内核被加载到内存中，它就开始初始化自身，并为系统准备必要的驱动和服务。内核会初始化内存管理系统、设置中断向量表、加载设备驱动程序等。
5. 用户空间服务启动：随着内核的初始化完成，接下来是启动用户空间的服务，启动相关服务以便用户登录。
6. 用户登录：用户通过登录界面输入用户名和密码，验证成功后进入操作系统桌面环境。

## 操作系统进程
进程（Process）是指计算机中已执行的程序。程序本身只是指令、数据及其组织形式的描述，相当于一个名词，进程才是程序（那些指令和数据）的真正执行实例。
若干进程有可能与同一个程序相关系，且每个进程皆可以同步（循序）或异步（平行）的方式独立执行。

现代计算机系统可在同一段时间内以进程的形式将多个程序加载到存储器中， 并借由时间共享（或称时分复用），以在一个处理器上表现出同时（平行性）执行的感觉。
同样的，使用多线程技术的操作系统或计算机体系结构， 同样程序的平行线程，可在多CPU主机或网络上真正同时执行（在不同的CPU上）。

用户下达执行程序的命令后，就会产生进程。同一程序可产生多个进程（一对多关系），以允许同时有多位用户执行同一程序，却不会相冲突。

进程需要一些资源才能完成工作，如CPU使用时间、存储器、文件以及I/O设备，且为依序逐一进行，也就是每个CPU核心任何时间内仅能执行一项进程。

### 进程的组成
1. 程序可执行机器代码的映像。
2. 分配到的存储器，存储器包括：可执行代码、输入或输出数据、调用堆栈信息（用于保存运行时数据）。
3. 分配给该进程的资源的操作系统描述符，例如文件描述符。
4. 安全特性，诸如进程拥有者和进程的权限集（可以容许的操作）。
5. 处理器状态，包含寄存器内容、物理存储器寻址等。当进程正在执行时，状态通常存储在寄存器，其他情况在存储器。

### 进程控制块
进程控制段（Process Control Block, PCB）是操作系统核心中一种数据结构，主要表示进程状态。
- **进程状态**：可以是 `new`、`ready`、`running`、`waiting` 或 `blocked` 等。
- **程序计数器**：接着要执行的指令地址。
- **CPU寄存器**：如累加器、变址寄存器、堆栈指针以及一般用途寄存器、状况代码等，主要用途在于中断时暂时存储资料，以便稍后继续利用；其数量及类别因计算机体系结构有所差异。
- **CPU排班法**：优先级、排班队列等指针以及其他参数。
- **存储器管理**：如标签页表等。
- **会计信息**：如CPU与实际时间之使用数量、时限、账号、工作或进程号码。
- **输入输出状态**：配置进程使用I/O设备，如磁带机。

进程在执行时，状态（state）会改变。所谓状态，就是指进程目前的动作：
- **新生**（new）：进程产生中。
- **执行**（running）：正在执行。
- **等待**（waiting）：等待某事发生，例如等待用户输入完成。亦称“阻塞”（blocked）
- **就绪**（ready）：排班中，等待CPU。
- **结束**（terminated）：完成执行。

各状态名称可能随不同操作系统而相异；对于单CPU系统（UP），任何时间可能有多个进程为等待、就绪，但必定仅有一个进程在执行。
> 注意: 进程的各个状态之间是不能随意切换的，例如当进程运行时因IO操作而阻塞，当IO操作完成后并不会直接恢复回运行态，而是转为就绪态等待CPU的调度。

### 进程管理
#### 进程调度
调度或译排班（Schedule）是将任务分配至资源的过程，在计算机或生产处理中尤为重要。  
调度多任务处理的主要目的，是随时保有一个行程在执行，藉以提高CPU使用率。事实上，行程就是一种任务，可利用的资源即是CPU。若能最有效率完成运算，对用户而言就不必久候。
常用的调度算法：先进先出、最短先做排班、LIFO等。

#### 上下文切换
上下文切换（英语：context switch），又称环境切换，电脑术语，是一个存储和重建CPU的状态（上下文），因此令多个进程（process）可以分享
单一CPU资源的计算过程。要切换CPU上的进程时，必须先行存储目前进程的状态，再将欲执行的进程之状态读回CPU中。

上下文切换通常是计算密集型的，操作系统中的许多设计都是针对上下文切换的优化。在进程间切换需要消耗一定的时间进行相关的管理工作——包括寄存器
和内存映射的保存与读取、更新各种内部的表等等。处理器或者操作系统不同，上下文切换时所涉及的内容也不尽相同。比如在Linux内核中，
上下文切换需要涉及寄存器（register）、栈指针（stack pointer）、程序计数器（program counter）的切换，但和地址空间的切换无关（虽然进程
在进行上下文切换时也需要做地址空间的切换）用户态线程之间也会发生类似的上下文切换，但这样的切换非常轻量。

切换时机有三种可能的情况会发生上下文切换，分别为：多工、中断处理、用户态或内核态切换

**多工**
其中行程有时候需要暂时离开CPU，让另一个行程进来CPU运作。在先占式多工系统中，每一个行程都将轮流执行不定长度的时间，这些时间段落称为时间片。
如果行程并非自愿让出CPU（例如执行I/O操作时，行程就需放弃CPU使用权），当时限到时，系统将产生一个定时中断，操作系统将排定由其它的行程来执行。
此机制用以确保CPU不致被较依赖处理器运算的行程垄断。若无定时中断，除非行程自愿让出CPU，否则该行程将持续执行。对于拥有较多I/O指令的行程，
往往执行不了多久，便需要让出CPU；而较依赖处理器的行程相对而言I/O操作较少，反而能一直持续使用CPU，便形成了垄断现象。

**中断处理**
在计算机科学中是指处理器接收到来自硬件或软件的信号，提示发生了某个事件，应予以注意，这种情况就称为中断。在接受到中断（Interrupt）的时候，
CPU必须要进行上下文切换。

软件中断则通常作为CPU指令集中的一个指令，以可编程的方式直接指示这种执行信息切换，并将处理导向一段中断处理代码。中断在计算机多任务处理，
尤其是即时系统中尤为有用。这样的系统，包括运行于其上的操作系统，也称“中断驱动”（interrupt-driven）。


**用户态或者内核态的切换**
当用户态和内核态切换发生的时候，并不需要进行上下文切换；并且用户态和kernel mode的切换本身并不是一个上下文切换。不过，根据操作系统的不同，
有时候会在此时进行一次上下文切换的步骤。

### 进程间通信
进程间通信（Inter-Process Communication，IPC）是一种技术或方法，用于在至少两个进程或线程之间传输数据或信号。每个进程都有自己独立的系统资源，
彼此隔离。为了实现不同进程之间的资源访问和协调工作，需要使用进程间通信。

通常，使用进程间通信的两个应用可以分为客户端和服务器（主从式架构）。客户端进程请求数据，服务器进程响应客户端的数据请求。有些应用既是服务
器又是客户端，这种情况在分布式计算中很常见。这些进程可以运行在同一台计算机上，也可以运行在通过网络连接的不同计算机上。

**主要的IPC方法**
- 文件
- 信号
- 套接字
- 消息队列
- 管道
- 命名管道
- 共享内存

### 线程
线程（英语：thread）在计算机科学中，是将进程划分为两个或多个线程（实例）或子进程，由单处理器（单线程）或多处理器（多线程）或多核处理系统并发执行。

线程有四种基本状态，分别为：
- **产生**（spawn）
- **阻塞**（block）
- **非阻塞**（unblock）
- **结束**（finish）

#### 线程组成
- **线程内核对象**(thread kernel object)
- **线程环境块**(thread environment block, TEB)
- **用户模式栈**(user-mode stack)（unblock）
- **内核模式栈**(kernal-mode stack)(thread environment block, TEB)
- **DLL线程连接**(attach)和线程分离(detach)通知(kernal-mode stack)